{{ 'collection-products.css' | asset_url | stylesheet_tag }}
{{ 'cart-notification.css' | asset_url | stylesheet_tag }}

{% liquid
  assign collection = section.settings.collection
  assign collection_title = section.settings.collection.title
%}

<section class="collection-products js-collection-products">
  <div class="collection-products__wrapper">
    <div class="collection-products__banner">
      {% assign collection_banner = section.settings.collection_custom_image | default: collection.featured_image %}

      {% if collection_banner != blank %}
        <picture class="collection-products__banner-picture">
          <source
            media="(max-width: 420px)"
            srcset="
              {{ collection_banner | image_url: height: 500 }} 1x,
              {{ collection_banner | image_url: height: 1000 }} 2x
            "
            type="image/webp"
          >

          <source
            media="(max-width: 991px)"
            srcset="
              {{ collection_banner | image_url: height: 600 }} 1x,
              {{ collection_banner | image_url: height: 1200 }} 2x
            "
            type="image/webp"
          >

          <img
            class="collection-products__banner-image"
            src="{{ collection_banner | image_url: height: 600 }}"
            srcset="
              {{ collection_banner | image_url: height: 600 }} 1x,
              {{ collection_banner | image_url: height: 1200 }} 2x
            "
            alt="{{ section.settings.collection.image.alt | escape }}"
            {% if section.index > 1 %}
              loading="lazy"
            {% endif %}
            width="400"
            height="582"
          >
        </picture>
      {% else %}
        <div class="collection-products__banner-placeholder">
          {{ 'collection-apparel-1' | placeholder_svg_tag: 'collection-products__banner-placeholder-svg' }}
        </div>
      {% endif %}

      <div class="collection-products__banner-info">
        {% if collection_title != blank %}
          <h2 class="collection-products__banner-title">{{ collection_title }}</h2>
        {% endif %}

        {% assign count = section.settings.collection.all_products_count %}

        {% if count > 0 %}
          <span class="collection-products__banner-count">
            {{ count }}
            {{ count | pluralize: 'product', 'products' }}
          </span>
        {% endif %}
      </div>
    </div>

    {% assign collection_products = section.settings.collection.products | default: collections.all.products %}

    {% if collection_products %}
      <div class="collection-products__list swiper">
        <div class="swiper-wrapper">
          {% for product in collection_products %}
            <div class="collection-products__item swiper-slide js-collection-products-item">
              <div class="collection-products__item-image-wrapper">
                {% if product.tags.size > 0 %}
                  <div class="collection-products__item-tags">
                    {% for tag in product.tags %}
                      {% assign sale_class = tag | downcase %}

                      <span class="collection-products__item-tag {% if sale_class contains 'sale' %}collection-products__item-tag--sale{% endif %}">
                        {{ tag | capitalize }}
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}

                <div class="collection-products__item-actions">
                  <button
                    class="collection-products__item-action js-add-to-cart"
                    aria-label="Add to cart"
                    data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                    data-available-quantity="{{ product.selected_or_first_available_variant.inventory_quantity }}"
                    {% unless product.selected_or_first_available_variant.available %}
                      disabled
                    {% endunless %}
                  ></button>
                </div>

                <a class="collection-products__item-link" href="{{ product.url }}">
                  {% assign color_option = product.options_by_name.Color | default: product.options_by_name.Colour %}

                  {% if color_option %}
                    {% for value in color_option.values %}
                      {% assign variant_image = value.variant.image %}

                      {% if variant_image %}
                        <picture
                          class="collection-products__item-picture js-collection-products-item-picture {% unless forloop.first %}hidden{% endunless %}"
                          data-variant-id="{{ value.variant.id }}"
                        >
                          {% render 'collection-product-picture', image: variant_image %}
                        </picture>
                      {% else %}
                        <div
                          class="collection-products__item-placeholder js-collection-products-item-picture {% unless forloop.first %}hidden{% endunless %}"
                          data-variant-id="{{ value.variant.id }}"
                        >
                          {{ 'product-apparel-2' | placeholder_svg_tag: 'collection-products__item-placeholder-svg' }}
                        </div>
                      {% endif %}
                    {% endfor %}

                  {% elsif product.featured_image %}
                    <picture class="collection-products__item-picture js-collection-products-item-picture">
                      {% render 'collection-product-picture', image: product.featured_image %}
                    </picture>

                  {% else %}
                    <div class="collection-products__item-placeholder">
                      {{ 'product-apparel-1' | placeholder_svg_tag: 'collection-products__item-placeholder-svg' }}
                    </div>
                  {% endif %}
                </a>
              </div>

              {% if color_option %}
                <div class="collection-products__item-swatches js-color-swatch">
                  {% for value in color_option.values %}
                    <button
                      class="collection-products__item-swatch js-color-swatch-item {% if forloop.first %}is-active{% endif %}"
                      type="button"
                      aria-label="{{ value.name }}"
                      data-variant-id="{{ value.variant.id }}"
                      data-variant-price="{{ value.variant.price | money }}"
                      data-variant-quantity="{{ value.variant.inventory_quantity }}"
                      data-variant-compare-price="{{ value.variant.compare_at_price | money }}"
                    >
                      <span
                        class="collection-products__item-swatch-color"
                        style="background-color: {{ value.swatch.color }}"
                      ></span>
                    </button>
                  {% endfor %}
                </div>
              {% endif %}

              <a class="collection-products__item-link" href="{{ product.url }}">
                <h3 class="collection-products__item-title">{{ product.title }}</h3>
              </a>

              {% liquid
                assign price_source = product

                if color_option
                  assign price_source = product.selected_or_first_available_variant
                endif
              %}

              <div class="collection-products__item-price-info">
                <span class="collection-products__item-price js-collection-products-item-price">
                  {{ price_source.price | money }}
                </span>

                {% if price_source.compare_at_price %}
                  <span class="collection-products__item-price collection-products__item-price--old js-collection-products-compare-price">
                    {{ price_source.compare_at_price | money }}
                  </span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
    {% endif %}
  </div>
</section>

<script src="{{ 'collection-products.js' | asset_url }}" defer></script>
<script src="{{ 'add-to-cart.js' | asset_url }}" defer></script>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css"
>

<script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>

{% schema %}
{
  "name": "Collection products",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "image_picker",
      "id": "collection_custom_image",
      "label": "Collection custom image"
    }
  ],
  "presets": [
    {
      "name": "Collection products",
      "category": "Custom Sections"
    }
  ]
}
{% endschema %}
